import{c as f,i as b}from"./chunk-DTPHU4DJ.js";import{J as a,L as n,P as v,T as h,e as s,i as c,m as o,x as p}from"./chunk-GOBX2HRP.js";var S=class r{constructor(t,e){this.http=t;this.router=e}api="/app/v1/sessions";_session$=new c(null);session$=this._session$.asObservable();sessionWatcherSub=null;watchIntervalMs=15e3;get currentSession(){return this._session$.value}refreshBySessionId(t){return t?this.http.post(`${this.api}/refresh/${t}`,{}):new s}refreshActivity(){let t=this.currentSession,e=t?.sessionId||t?.id;if(e)return this.refreshBySessionId(e);let i=localStorage.getItem("token");return i?this.getByToken(i).pipe(a(l=>{let u=l?.sessionId||l?.id;return u?this.refreshBySessionId(u):o(null)})):o(null)}markOnline(t){return t?this.http.post(`${this.api}/online/${t}`,{}):new s}markInactive(t){return t?this.http.post(`${this.api}/inactive/${t}`,{}):new s}getByToken(t){return this.http.get(`${this.api}/token/${t}`).pipe(n(e=>{this._session$.next(e),e&&e.valid!==!1&&this.startSessionWatcher()}))}getByUserId(t){return t?this.http.get(`${this.api}/user/${t}`):new s}logout(t){return this.http.post(`${this.api}/logout/${t}`,{}).pipe(n(()=>{let e=this.currentSession,i=e?.sessionId||e?.id;i&&i===t&&this.handleInvalidSession()}))}logoutAll(t){return t?this.http.post(`${this.api}/logout/user/${t}`,{}).pipe(n(()=>{let i=this.currentSession?.userId;i&&i===t&&this.handleInvalidSession()})):new s}startSessionWatcher(){if(this.sessionWatcherSub)return;let t=localStorage.getItem("token");t&&(this.sessionWatcherSub=p(0,this.watchIntervalMs).pipe(a(()=>this.getByTokenSilent(t))).subscribe({next:e=>{!e||e.valid===!1?this.handleInvalidSession():this._session$.next(e)},error:e=>{console.warn("Session watcher detected invalid session",e),this.handleInvalidSession()}}))}stopSessionWatcher(){this.sessionWatcherSub&&(this.sessionWatcherSub.unsubscribe(),this.sessionWatcherSub=null)}getByTokenSilent(t){return this.http.get(`${this.api}/token/${t}`)}handleInvalidSession(){try{localStorage.removeItem("token")}catch(t){console.warn("Could not clear token",t)}this._session$.next(null),this.stopSessionWatcher();try{this.router.navigate(["/auth"])}catch(t){console.warn("Router navigation to /auth failed",t),window.location.href="/auth"}}static \u0275fac=function(e){return new(e||r)(h(f),h(b))};static \u0275prov=v({token:r,factory:r.\u0275fac,providedIn:"root"})};export{S as a};
