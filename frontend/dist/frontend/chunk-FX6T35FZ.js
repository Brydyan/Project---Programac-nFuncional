import{a as K}from"./chunk-ANM52DLC.js";import{a as X}from"./chunk-5APZ7EMV.js";import{a as Q}from"./chunk-DYV3ILQ6.js";import{a as J}from"./chunk-4N7PJ33N.js";import{b as W,d as G,g as L,q}from"./chunk-EHQ257GK.js";import{c as z,g as H}from"./chunk-DTPHU4DJ.js";import{Ea as c,Ja as y,Lb as B,Mb as R,Na as M,Nb as A,P as _,Pb as $,Qb as V,T as S,U as b,Wa as h,Xa as s,Ya as r,Z as g,Za as v,_ as u,a as x,b as I,bb as O,cb as C,eb as w,fb as P,gb as o,hb as d,ib as E,jb as T,kb as k,lb as U,ob as N,qb as j,sb as F,ua as a,zb as D}from"./chunk-GOBX2HRP.js";var f=class i{constructor(e){this.http=e}apiUrl="/app/v1/channel-messages";getByChannel(e){return this.http.get(`${this.apiUrl}/channel/${e}`)}create(e){return this.http.post(this.apiUrl,e)}getById(e){return this.http.get(`${this.apiUrl}/${e}`)}update(e,t){return this.http.put(`${this.apiUrl}/${e}`,t)}delete(e){return this.http.delete(`${this.apiUrl}/${e}`)}static \u0275fac=function(t){return new(t||i)(S(z))};static \u0275prov=_({token:i,factory:i.\u0275fac,providedIn:"root"})};var te=(i,e)=>({"message-right":i,"message-left":e});function ne(i,e){i&1&&(s(0,"div",18)(1,"h3"),o(2,"No hay mensajes a\xFAn"),r(),s(3,"p"),o(4,"Comienza la conversaci\xF3n enviando un mensaje."),r()())}function ie(i,e){if(i&1&&(s(0,"div",19)(1,"div",20)(2,"div",21),o(3),r(),s(4,"div",22),o(5),r(),s(6,"div",23),o(7),j(8,"date"),r()()()),i&2){let t=e.$implicit,n=w();h("ngClass",N(7,te,t.senderId===n.currentUserId,t.senderId!==n.currentUserId)),a(3),d(n.getSenderName(t.senderId)),a(2),d(t.messageContent),a(2),d(F(8,4,t.timestamp,"shortTime"))}}function re(i,e){if(i&1&&(s(0,"div",24),v(1,"div",25),s(2,"span",26),o(3),r(),v(4,"span",27),r()),i&2){let t=e.$implicit;a(3),d(t.username),a(),P("online",t.online)}}var Y=class i{constructor(e,t,n,l,m){this.channelMsgService=e;this.channelService=t;this.realtime=n;this.route=l;this.userService=m}sessionService=b(J);cdr=b(D);channelId;channelName;currentUserId;messages=[];newMessage="";allUsers=[];membersInfo=[];onlineMembers=[];wsSub;ngOnInit(){let e=this.route.snapshot.paramMap.get("id");e&&(this.channelId=e),this.initSession()}ngOnDestroy(){this.wsSub?.unsubscribe()}initSession(){let e=localStorage.getItem("token");if(!e)return console.error("No token found");this.sessionService.getByToken(e).subscribe({next:t=>{this.currentUserId=t.userId,this.loadMessages(),this.loadAllUsers()},error:t=>console.error("Error obteniendo sesi\xF3n del usuario",t)})}loadMessages(){this.channelId&&this.channelMsgService.getByChannel(this.channelId).subscribe({next:e=>{this.messages=e||[],setTimeout(()=>this.scrollToBottom(),50),this.cdr.detectChanges()},error:e=>console.error("Error al cargar mensajes del canal",e)})}loadAllUsers(){this.channelService.getAll().subscribe(e=>{let t=e.find(n=>n.id===this.channelId);t&&(this.channelName=t.name,this.membersInfo=t.members.map(n=>({id:n,userId:n,username:`Usuario ${n}`,online:!1})),this.updateOnlineMembers(),this.subscribeRealtime(),t.members.length>0&&this.userService.getUsersByIds(t.members).subscribe(n=>{this.membersInfo=this.membersInfo.map(l=>{let m=n.find(p=>p.id===l.userId);return I(x({},l),{username:m?.username||l.username})}),this.cdr.detectChanges()}))})}updateOnlineMembers(){this.onlineMembers=this.membersInfo.filter(e=>e.online),this.cdr.detectChanges()}subscribeRealtime(){this.wsSub=this.realtime.subscribeToChannelEvents(this.currentUserId).subscribe(e=>{if(e.type==="USER_STATUS_CHANGED"){let t=this.membersInfo.find(n=>n.userId===e.payload.userId);t&&(t.online=e.payload.online),this.updateOnlineMembers()}})}sendMessage(){if(!this.newMessage.trim()||!this.currentUserId)return;let e={channel:this.channelId,senderId:this.currentUserId,messageContent:this.newMessage.trim(),status:"SENT"};this.channelMsgService.create(e).subscribe({next:t=>{this.messages.push(t),this.newMessage="",setTimeout(()=>this.scrollToBottom(),20),this.cdr.detectChanges()},error:t=>console.error("Error al enviar mensaje",t)})}scrollToBottom(){let e=document.getElementById("channel-thread-messages");e&&(e.scrollTop=e.scrollHeight)}getSenderName(e){return e===this.currentUserId?"T\xFA":this.membersInfo.find(t=>t.userId===e)?.username||e}static \u0275fac=function(t){return new(t||i)(c(f),c(X),c(Q),c(H),c(K))};static \u0275cmp=y({type:i,selectors:[["app-channels-thread"]],inputs:{channelId:"channelId",channelName:"channelName"},decls:24,vars:6,consts:[["scrollMe",""],[1,"channel-container"],[1,"channel-header"],[1,"header-left"],[1,"channel-title"],[1,"channel-status"],[1,"header-right"],[1,"icon-btn"],[1,"channel-body"],[1,"chat-area"],["class","empty-state",4,"ngIf"],["class","message-row",3,"ngClass",4,"ngFor","ngForOf"],[1,"channel-sidebar"],["class","member-item",4,"ngFor","ngForOf"],[1,"chat-input"],[1,"input-area"],["type","text","placeholder","Escribe tu mensaje\u2026",3,"ngModelChange","keyup.enter","ngModel"],[1,"send-btn",3,"click"],[1,"empty-state"],[1,"message-row",3,"ngClass"],[1,"message-bubble"],[1,"message-author"],[1,"message-text"],[1,"message-time"],[1,"member-item"],[1,"avatar"],[1,"member-name"],[1,"online-dot"]],template:function(t,n){if(t&1){let l=O();s(0,"div",1)(1,"header",2)(2,"div",3)(3,"h2",4),o(4),r(),s(5,"span",5),o(6,"\u{1F7E2} En l\xEDnea"),r()(),s(7,"div",6)(8,"button",7),o(9,"\u22EF"),r()()(),s(10,"div",8)(11,"main",9,0),M(13,ne,5,0,"div",10)(14,ie,9,10,"div",11),r(),s(15,"aside",12)(16,"h3"),o(17),r(),M(18,re,5,3,"div",13),r()(),s(19,"footer",14)(20,"div",15)(21,"input",16),U("ngModelChange",function(p){return g(l),k(n.newMessage,p)||(n.newMessage=p),u(p)}),C("keyup.enter",function(){return g(l),u(n.sendMessage())}),r(),s(22,"button",17),C("click",function(){return g(l),u(n.sendMessage())}),o(23,"Enviar"),r()()()()}t&2&&(a(4),d(n.channelName),a(9),h("ngIf",n.messages.length===0),a(),h("ngForOf",n.messages),a(3),E("Miembros en l\xEDnea (",n.onlineMembers.length,")"),a(),h("ngForOf",n.membersInfo),a(3),T("ngModel",n.newMessage))},dependencies:[V,B,R,A,q,W,G,L,$],styles:[".channel-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%;background:#0f0f17;color:#fff}.channel-header[_ngcontent-%COMP%]{padding:15px 20px;background:#14141f;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222}.channel-title[_ngcontent-%COMP%]{margin:0;font-size:20px}.channel-status[_ngcontent-%COMP%]{font-size:14px;margin-left:10px;color:#6edc6e}.channel-body[_ngcontent-%COMP%]{display:flex;flex:1;height:100%}.chat-area[_ngcontent-%COMP%]{flex:3;padding:20px;overflow-y:auto}.empty-state[_ngcontent-%COMP%]{text-align:center;margin-top:50px;opacity:.6}.message-row[_ngcontent-%COMP%]{display:flex;margin-bottom:15px}.message-left[_ngcontent-%COMP%]{justify-content:flex-start}.message-right[_ngcontent-%COMP%]{justify-content:flex-end}.message-bubble[_ngcontent-%COMP%]{max-width:65%;padding:12px 15px;border-radius:12px;background:#1e1e2e}.message-right[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background:#a48cfb;color:#000}.message-author[_ngcontent-%COMP%]{font-size:13px;opacity:.7;margin-bottom:5px}.message-text[_ngcontent-%COMP%]{font-size:15px}.message-time[_ngcontent-%COMP%]{margin-top:5px;font-size:12px;opacity:.6;text-align:right}.channel-sidebar[_ngcontent-%COMP%]{flex:1;padding:20px;background:#14141f;border-left:1px solid #222}.member-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;margin-bottom:10px}.avatar[_ngcontent-%COMP%]{width:35px;height:35px;background:gray;border-radius:50%;flex-shrink:0}.member-name[_ngcontent-%COMP%]{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.online-dot[_ngcontent-%COMP%]{width:10px;height:10px;border-radius:50%;background:gray;flex-shrink:0}.online-dot.online[_ngcontent-%COMP%]{background:#6edc6e}.chat-input[_ngcontent-%COMP%]{padding:15px;border-top:1px solid #222;background:#14141f}.input-area[_ngcontent-%COMP%]{display:flex;align-items:center}input[_ngcontent-%COMP%]{flex:1;padding:12px;border-radius:10px;border:none;outline:none;background:#1e1e2e;color:#fff}.send-btn[_ngcontent-%COMP%]{margin-left:10px;padding:10px 15px;background:#a48cfb;border:none;cursor:pointer;border-radius:8px}"]})};export{Y as ChannelsThread};
