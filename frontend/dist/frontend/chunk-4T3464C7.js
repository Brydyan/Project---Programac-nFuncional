import{a as V}from"./chunk-2OR7M653.js";import{a as q}from"./chunk-Y6Z53ZLJ.js";import{a as H}from"./chunk-ANM52DLC.js";import{a as W}from"./chunk-DYV3ILQ6.js";import{a as $}from"./chunk-4N7PJ33N.js";import{b as B,d as z,g as R,q as j}from"./chunk-EHQ257GK.js";import{c as U,g as A}from"./chunk-DTPHU4DJ.js";import{Ja as y,Lb as w,Mb as L,Na as I,Nb as N,Pb as F,Qb as D,U as l,Wa as h,Xa as i,Ya as s,Za as C,cb as u,eb as x,gb as a,hb as m,ib as v,jb as P,kb as O,lb as M,mb as S,ob as f,pb as _,qb as E,sa as b,sb as k,ua as d,zb as T}from"./chunk-GOBX2HRP.js";var X=(c,t,e)=>({online:c,inactive:t,offline:e}),Y=(c,t)=>({"message-row--right":c,"message-row--left":t}),G=(c,t)=>({"message-bubble--right":c,"message-bubble--left":t});function K(c,t){c&1&&(i(0,"div",20),a(1," Cargando conversaci\xF3n... "),s())}function Q(c,t){c&1&&(i(0,"div",21)(1,"div",22),a(2,"Empieza la conversaci\xF3n"),s(),i(3,"div",23),a(4," Env\xEDa el primer mensaje para iniciar el chat. "),s()())}function Z(c,t){if(c&1&&(i(0,"div",24)(1,"div",25)(2,"p"),a(3),s(),i(4,"span",26),a(5),E(6,"date"),s()()()),c&2){let e=t.$implicit,n=x();h("ngClass",f(7,Y,n.isMine(e),!n.isMine(e))),d(),h("ngClass",f(10,G,n.isMine(e),!n.isMine(e))),d(2),m(e.content),d(2),v(" ",k(6,4,e.timestamp,"shortTime")," ")}}var J=class c{convEvents=l(q);route=l(A);sessionService=l($);messageService=l(V);userService=l(H);realtimeService=l(W);http=l(U);cdr=l(T);contactId;currentUserId;contactDisplayName=null;messages=[];newMessage="";loading=!0;contactPresence=null;get contactStatusLabel(){return this.contactPresence==="ONLINE"?"En l\xEDnea":this.contactPresence==="INACTIVE"?"Inactivo":"Fuera de l\xEDnea"}routeSub;realtimeSub;presenceIntervalId=null;activityTimestamp=0;inactivityTimer=null;activityListener=this.onUserActivity.bind(this);beforeUnloadListener=this.onBeforeUnload.bind(this);ngOnInit(){this.routeSub=this.route.paramMap.subscribe(t=>{let e=t.get("id");e&&(this.contactId=e,this.contactDisplayName=null,this.messages=[],this.loading=!0,this.cdr.detectChanges(),this.loadContact(),this.initChat(),document.addEventListener("click",this.activityListener),document.addEventListener("keydown",this.activityListener),document.addEventListener("mousemove",this.activityListener),document.addEventListener("touchstart",this.activityListener),window.addEventListener("beforeunload",this.beforeUnloadListener))})}ngOnDestroy(){this.routeSub?.unsubscribe(),this.realtimeSub?.unsubscribe(),this.stopPresencePolling(),document.removeEventListener("click",this.activityListener),document.removeEventListener("keydown",this.activityListener),document.removeEventListener("mousemove",this.activityListener),document.removeEventListener("touchstart",this.activityListener),window.removeEventListener("beforeunload",this.beforeUnloadListener),this.stopInactivityTimer()}loadContact(){this.contactId&&this.userService.getUserById(this.contactId).subscribe({next:t=>{this.contactDisplayName=t.displayName||"@"+t.username,this.cdr.detectChanges()},error:()=>{this.contactDisplayName=null,this.cdr.detectChanges()}})}initChat(){let t=localStorage.getItem("token");if(!t){this.loading=!1,this.cdr.detectChanges(),this.startPresencePolling();return}this.sessionService.getByToken(t).subscribe({next:e=>{this.currentUserId=e.userId;let n=e.sessionId;this.sessionService.markOnline(n).subscribe({next:()=>{this.recordActivity(),this.startInactivityTimer(n),this.startPresencePolling()},error:r=>console.error("markOnline error",r)}),this.loadMessages();let o=this.buildConversationId(this.currentUserId,this.contactId);this.realtimeSub?.unsubscribe(),this.realtimeSub=this.realtimeService.subscribeToDirect(o).subscribe(r=>{r.senderId!==this.currentUserId&&(this.messages.some(p=>p.id===r.id)||(this.messages=[...this.messages,r],this.scrollToBottom(),this.cdr.detectChanges(),this.convEvents.notifyRefresh()))})},error:()=>{this.loading=!1,this.cdr.detectChanges()}})}startPresencePolling(){this.stopPresencePolling(),this.fetchContactPresence(),this.presenceIntervalId=setInterval(()=>this.fetchContactPresence(),15e3)}stopPresencePolling(){this.presenceIntervalId&&(clearInterval(this.presenceIntervalId),this.presenceIntervalId=null)}fetchContactPresence(){this.contactId&&this.http.get(`/app/v1/presence/realtime/${this.contactId}`,{responseType:"text"}).subscribe({next:t=>{let e="OFFLINE";if(!t)e="OFFLINE";else{let n=t.trim();if(n.startsWith("{")||n.startsWith("["))try{let o=JSON.parse(n);if(Array.isArray(o)){let r=o.some(g=>(g.status||g)==="ONLINE"),p=o.some(g=>(g.status||g)==="INACTIVE");e=r?"ONLINE":p?"INACTIVE":"OFFLINE"}else o&&typeof o=="object"?e=o.status||o.presence||"OFFLINE":e=String(o)||"OFFLINE"}catch{e=n}else e=n}e!=="ONLINE"&&e!=="INACTIVE"&&(e="OFFLINE"),this.contactPresence=e,this.cdr.detectChanges()},error:()=>{this.contactPresence="OFFLINE",this.cdr.detectChanges()}})}onUserActivity(){if(!localStorage.getItem("token"))return;let e=this.sessionService.currentSession;!e||!e.sessionId||(console.debug("[Presence] user activity detected, sessionId=",e.sessionId),this.sessionService.markOnline(e.sessionId).subscribe({next:()=>{console.debug("[Presence] markOnline success for",e.sessionId),this.recordActivity()},error:n=>console.error("markOnline onUserActivity",n)}))}recordActivity(){this.activityTimestamp=Date.now(),this.stopInactivityTimer();let t=this.sessionService.currentSession;t&&t.sessionId&&this.startInactivityTimer(t.sessionId)}startInactivityTimer(t){this.stopInactivityTimer(),this.inactivityTimer=setTimeout(()=>{console.debug("[Presence] inactivity timer fired for",t),this.sessionService.markInactive(t).subscribe({next:()=>{console.log("Sesi\xF3n marcada como inactive por inactividad",t)},error:e=>console.error("markInactive error",e)})},300*1e3)}markPresenceOnlineForDebug(){let e=this.sessionService.currentSession?.sessionId;if(!e)return console.warn("[Presence debug] no sessionId");console.debug("[Presence debug] forcing markOnline for",e),this.sessionService.markOnline(e).subscribe({next:()=>console.log("markOnline debug ok"),error:n=>console.error(n)})}markPresenceInactiveForDebug(){let e=this.sessionService.currentSession?.sessionId;if(!e)return console.warn("[Presence debug] no sessionId");console.debug("[Presence debug] forcing markInactive for",e),this.sessionService.markInactive(e).subscribe({next:()=>console.log("markInactive debug ok"),error:n=>console.error(n)})}stopInactivityTimer(){this.inactivityTimer&&(clearTimeout(this.inactivityTimer),this.inactivityTimer=null)}onBeforeUnload(t){let e=this.sessionService.currentSession;if(!(!e||!e.sessionId))try{let n=localStorage.getItem("token"),o=`/app/v1/sessions/inactive/${e.sessionId}`;if(n&&(o+=`?token=${encodeURIComponent(n)}`),navigator&&navigator.sendBeacon)try{let r=n?JSON.stringify({token:n}):"";navigator.sendBeacon(o,r)}catch{let p=new XMLHttpRequest;p.open("POST",`/app/v1/sessions/inactive/${e.sessionId}`,!1),n&&p.setRequestHeader("Authorization",`Bearer ${n}`);try{p.send(null)}catch{}}else{let r=new XMLHttpRequest;r.open("POST",`/app/v1/sessions/inactive/${e.sessionId}`,!1),n&&r.setRequestHeader("Authorization",`Bearer ${n}`);try{r.send(null)}catch{}}}catch{}}buildConversationId(t,e){return t<e?`${t}_${e}`:`${e}_${t}`}loadMessages(){if(!this.currentUserId||!this.contactId){this.loading=!1,this.cdr.detectChanges();return}this.loading=!0,this.cdr.detectChanges(),this.messageService.getDirectConversation(this.currentUserId,this.contactId).subscribe({next:t=>{this.messages=t,this.loading=!1,this.scrollToBottom(),this.cdr.detectChanges();try{let e=this.buildConversationId(this.currentUserId,this.contactId);this.messageService.markConversationRead(e,this.currentUserId).subscribe({next:()=>{this.convEvents.notifyRefresh()},error:n=>console.error("markConversationRead error",n)})}catch{}},error:t=>{console.error("Error cargando mensajes",t),this.loading=!1,this.cdr.detectChanges()}})}sendMessage(){let t=this.newMessage.trim();!t||!this.currentUserId||!this.contactId||this.messageService.sendDirect(this.currentUserId,this.contactId,t).subscribe({next:e=>{this.newMessage="",this.messages=[...this.messages,e],this.scrollToBottom(),this.cdr.detectChanges(),this.convEvents.notifyRefresh()},error:e=>{console.error("Error enviando mensaje",e)}})}isMine(t){return t.senderId===this.currentUserId}scrollToBottom(){setTimeout(()=>{let t=document.getElementById("chat-thread-messages");t&&(t.scrollTop=t.scrollHeight)})}static \u0275fac=function(e){return new(e||c)};static \u0275cmp=y({type:c,selectors:[["app-chat-thread"]],decls:35,vars:13,consts:[[1,"chat-window"],[1,"chat-header"],[1,"chat-header-left"],[1,"avatar"],["alt","Avatar",3,"src"],[1,"contact-info"],[1,"contact-name"],[1,"contact-status",3,"ngClass"],[1,"chat-header-right"],["type","button",1,"icon-btn"],["id","chat-thread-messages",1,"chat-body"],["class","loading",4,"ngIf"],["class","empty-state",4,"ngIf"],["class","message-row",3,"ngClass",4,"ngFor","ngForOf"],[1,"chat-input-area"],[1,"input-wrapper"],["type","button",1,"attach-btn"],["type","text","placeholder","Escribe tu mensaje aqu\xED...",3,"ngModelChange","keyup.enter","ngModel"],["type","button",1,"send-btn",3,"click"],[1,"chat-footer-links"],[1,"loading"],[1,"empty-state"],[1,"empty-title"],[1,"empty-subtitle"],[1,"message-row",3,"ngClass"],[1,"message-bubble",3,"ngClass"],[1,"message-time"]],template:function(e,n){e&1&&(i(0,"div",0)(1,"header",1)(2,"div",2)(3,"div",3),C(4,"img",4),s(),i(5,"div",5)(6,"div",6),a(7),s(),i(8,"div",7),a(9),s()()(),i(10,"div",8)(11,"button",9),a(12,"\u{1F4DE}"),s(),i(13,"button",9),a(14,"\u{1F3A5}"),s(),i(15,"button",9),a(16,"\u22EF"),s()()(),i(17,"main",10),I(18,K,2,0,"div",11)(19,Q,5,0,"div",12)(20,Z,7,13,"div",13),s(),i(21,"footer",14)(22,"div",15)(23,"button",16),a(24,"\u{1F4CE}"),s(),i(25,"input",17),M("ngModelChange",function(r){return O(n.newMessage,r)||(n.newMessage=r),r}),u("keyup.enter",function(){return n.sendMessage()}),s(),i(26,"button",18),u("click",function(){return n.sendMessage()}),a(27," \u27A4 "),s()()(),i(28,"div",19)(29,"span"),a(30,"Enlaces R\xE1pidos"),s(),i(31,"span"),a(32,"\xB7"),s(),i(33,"span"),a(34,"Soporte"),s()()()),e&2&&(d(4),h("src",S("https://i.pravatar.cc/100?u=",n.contactId),b),d(3),v(" ",n.contactDisplayName||"Chat 1 a 1"," "),d(),h("ngClass",_(9,X,n.contactPresence==="ONLINE",n.contactPresence==="INACTIVE",n.contactPresence==="OFFLINE")),d(),m(n.contactStatusLabel),d(9),h("ngIf",n.loading),d(),h("ngIf",!n.loading&&n.messages.length===0),d(),h("ngForOf",n.messages),d(5),P("ngModel",n.newMessage))},dependencies:[D,w,L,N,j,B,z,R,F],styles:["[_nghost-%COMP%]{display:block;height:100%}.chat-window[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%;background:#0f172a;color:#f9fafb;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;border-radius:.75rem;overflow:hidden}.chat-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:#020617;border-bottom:1px solid #111827}.chat-header-left[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px}.avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:999px;overflow:hidden;border:2px solid #6366f1}.avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.contact-info[_ngcontent-%COMP%]{display:flex;flex-direction:column}.contact-name[_ngcontent-%COMP%]{font-weight:600;font-size:15px}.contact-status[_ngcontent-%COMP%]{font-size:12px;color:#fff}.contact-status.online[_ngcontent-%COMP%]{color:#4ade80}.contact-status.inactive[_ngcontent-%COMP%]{color:#f59e0b}.contact-status.offline[_ngcontent-%COMP%]{color:#fff}.chat-header-right[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px}.icon-btn[_ngcontent-%COMP%]{border:none;background:transparent;color:#9ca3af;cursor:pointer;font-size:18px;padding:4px;border-radius:999px;transition:background .15s ease,color .15s ease}.icon-btn[_ngcontent-%COMP%]:hover{background:#111827;color:#e5e7eb}.chat-body[_ngcontent-%COMP%]{flex:1;padding:16px 20px;background:#020617;overflow-y:auto}.message-row[_ngcontent-%COMP%]{display:flex;margin-bottom:10px}.message-row--left[_ngcontent-%COMP%]{justify-content:flex-start}.message-row--right[_ngcontent-%COMP%]{justify-content:flex-end}.message-bubble[_ngcontent-%COMP%]{max-width:70%;padding:8px 12px;border-radius:18px;font-size:14px;line-height:1.4;position:relative;box-shadow:0 2px 6px #0f172a99}.message-bubble[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 4px}.message-time[_ngcontent-%COMP%]{font-size:11px;opacity:.8;display:block;text-align:right}.message-bubble--left[_ngcontent-%COMP%]{background:#111827;color:#e5e7eb;border-bottom-left-radius:4px}.message-bubble--right[_ngcontent-%COMP%]{background:#6366f1;color:#f9fafb;border-bottom-right-radius:4px}.typing-indicator[_ngcontent-%COMP%]{padding:8px 20px;font-size:12px;color:#9ca3af;background:#020617;border-top:1px solid #111827}.chat-input-area[_ngcontent-%COMP%]{padding:10px 20px;background:#020617;border-top:1px solid #111827}.input-wrapper[_ngcontent-%COMP%]{display:flex;align-items:center;gap:10px;background:#020617;border-radius:999px;border:1px solid #1f2937;padding:6px 10px}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1;border:none;background:transparent;color:#f9fafb;font-size:14px;outline:none}.input-wrapper[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]::placeholder{color:#6b7280}.attach-btn[_ngcontent-%COMP%], .send-btn[_ngcontent-%COMP%]{border:none;background:transparent;cursor:pointer;font-size:18px;display:inline-flex;align-items:center;justify-content:center}.send-btn[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:999px;background:#6366f1;color:#f9fafb;flex-shrink:0;transition:transform .1s ease,box-shadow .1s ease,background .1s ease}.send-btn[_ngcontent-%COMP%]:hover{background:#4f46e5;box-shadow:0 0 12px #6366f199;transform:translateY(-1px)}.chat-footer-links[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;padding:6px 16px;font-size:11px;color:#9ca3af;background:#020617;border-top:1px solid #111827}.empty-state[_ngcontent-%COMP%]{height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:.25rem;color:#9ca3af}.empty-title[_ngcontent-%COMP%]{font-size:16px;font-weight:600;color:#e5e7eb}.empty-subtitle[_ngcontent-%COMP%]{font-size:13px}"]})};export{J as ChatThread};
