import{a as K}from"./chunk-Y6Z53ZLJ.js";import{a as A}from"./chunk-ANM52DLC.js";import{a as q}from"./chunk-DYV3ILQ6.js";import{a as W}from"./chunk-4N7PJ33N.js";import{b as B,d as $,g as Y,q as H}from"./chunk-EHQ257GK.js";import{c as b,i as L}from"./chunk-DTPHU4DJ.js";import{Ea as v,Ja as k,Mb as j,Na as f,Nb as V,P as E,Qb as R,T,Wa as l,Xa as o,Ya as r,Z as u,Za as O,_ as g,a as y,b as I,bb as _,cb as h,eb as p,fb as D,gb as a,hb as C,ib as x,jb as N,kb as U,lb as F,sa as M,ua as s,zb as z}from"./chunk-GOBX2HRP.js";var w=class n{constructor(t){this.http=t}baseUrl="/app/v1/conversations";getByUser(t){return this.http.get(`${this.baseUrl}/${t}`)}static \u0275fac=function(e){return new(e||n)(T(b))};static \u0275prov=E({token:n,factory:n.\u0275fac,providedIn:"root"})};function te(n,t){n&1&&(o(0,"div",13),a(1," Cargando conversaciones... "),r())}function ne(n,t){if(n&1&&(o(0,"div",14),a(1),r()),n&2){let e=p();s(),x(" ",e.error," ")}}function ie(n,t){n&1&&(o(0,"span"),a(1,"En l\xEDnea"),r())}function oe(n,t){n&1&&(o(0,"span"),a(1,"Inactivo"),r())}function re(n,t){n&1&&(o(0,"span"),a(1,"Fuera de l\xEDnea"),r())}function ae(n,t){if(n&1&&(o(0,"small"),f(1,ie,2,0,"span",24)(2,oe,2,0,"span",24)(3,re,2,0,"span",24),r()),n&2){let e=p().$implicit;s(),l("ngIf",e.presenceStatus==="ONLINE"),s(),l("ngIf",e.presenceStatus==="INACTIVE"),s(),l("ngIf",e.presenceStatus==="OFFLINE")}}function se(n,t){if(n&1&&(o(0,"span",29),a(1),r()),n&2){let e=p().$implicit;s(),x(" ",e.unreadCount," ")}}function ce(n,t){if(n&1){let e=_();o(0,"button",17),h("click",function(){let c=u(e).$implicit,d=p(2);return g(d.openConversation(c))}),o(1,"div",18),O(2,"img",19),r(),o(3,"div",20)(4,"div",21)(5,"span",22),a(6),r(),o(7,"span",23),f(8,ae,4,3,"small",24),r(),o(9,"span",25),a(10),r()(),o(11,"div",26)(12,"span",27),a(13),r(),f(14,se,2,1,"span",28),r()()()}if(n&2){let e=t.$implicit,i=p(2);D("active",e.id===i.selectedConversationId),s(2),l("src",e.avatarUrl||"https://i.pravatar.cc/100?u="+e.id,M)("alt",e.name),s(4),C(e.name),s(2),l("ngIf",e.presenceStatus),s(2),C(e.lastTimeLabel),s(3),x(" ",e.lastMessage||"Sin mensajes a\xFAn"," "),s(),l("ngIf",e.unreadCount>0)}}function le(n,t){if(n&1&&(o(0,"div",15),f(1,ce,15,9,"button",16),r()),n&2){let e=p();s(),l("ngForOf",e.conversations)}}function de(n,t){n&1&&(o(0,"div",30)(1,"h3"),a(2,"No tienes conversaciones todav\xEDa"),r(),o(3,"p"),a(4,"Inicia una nueva conversaci\xF3n con el bot\xF3n de arriba."),r()())}function pe(n,t){n&1&&(o(0,"p",43),a(1," Escribe para buscar personas\u2026 "),r())}function ve(n,t){if(n&1&&(o(0,"p",43),a(1),r()),n&2){let e=p(2);s(),x(' No se encontraron usuarios para "',e.searchTerm,'". ')}}function me(n,t){if(n&1){let e=_();o(0,"button",44),h("click",function(){let c=u(e).$implicit,d=p(2);return g(d.startConversationWith(c))}),o(1,"div",45),O(2,"img",19),r(),o(3,"div",46)(4,"span",47),a(5),r(),o(6,"span",48),a(7),r()()()}if(n&2){let e=t.$implicit;s(2),l("src",e.avatarUrl||"https://i.pravatar.cc/100?u="+e.id,M)("alt",e.displayName),s(3),C(e.displayName),s(2),x("@",e.username)}}function ue(n,t){if(n&1){let e=_();o(0,"div",31)(1,"div",32),h("click",function(){u(e);let c=p();return g(c.closeNewConversation())}),r(),o(2,"div",33),h("click",function(c){return u(e),g(c.stopPropagation())}),o(3,"header",34)(4,"div",35)(5,"h3"),a(6,"Iniciar nueva conversaci\xF3n"),r(),o(7,"p"),a(8,"Busca un usuario por nombre o @usuario para empezar a chatear."),r()(),o(9,"button",36),h("click",function(){u(e);let c=p();return g(c.closeNewConversation())}),a(10," \u2715 "),r()(),o(11,"div",37)(12,"span",38),a(13,"\u{1F50D}"),r(),o(14,"input",39),F("ngModelChange",function(c){u(e);let d=p();return U(d.searchTerm,c)||(d.searchTerm=c),g(c)}),h("input",function(){u(e);let c=p();return g(c.onSearchChange())}),r()(),o(15,"div",40),f(16,pe,2,0,"p",41)(17,ve,2,1,"p",41)(18,me,8,4,"button",42),r()()()}if(n&2){let e=p();s(14),N("ngModel",e.searchTerm),s(2),l("ngIf",!e.searchTerm),s(),l("ngIf",e.searchTerm&&e.searchResults.length===0),s(),l("ngForOf",e.searchResults)}}var G=class n{constructor(t,e,i,c,d,S,m,P){this.router=t;this.convService=e;this.userService=i;this.sessionService=c;this.convEvents=d;this.realtimeService=S;this.http=m;this.cdr=P}conversations=[];loading=!0;initialLoadDone=!1;error=null;currentUserId=null;showNewConversation=!1;searchTerm="";searchResults=[];inboxSub;eventsSub;selectedConversationId=null;ngOnInit(){let t=localStorage.getItem("token");if(!t){this.loading=!1,this.cdr.detectChanges();return}console.log("[Conversations] ngOnInit, pidiendo sesi\xF3n..."),this.sessionService.getByToken(t).subscribe({next:e=>{console.log("[Conversations] sesi\xF3n OK",e),this.currentUserId=e.userId,this.loadConversations(!0),this.eventsSub=this.convEvents.refresh$.subscribe(()=>{console.log("[Conversations] refresh$ \u2192 recargar sin spinner"),this.loadConversations(!1)}),this.inboxSub=this.realtimeService.subscribeToInbox(this.currentUserId).subscribe(i=>{console.log("[Conversations] nuevo mensaje en inbox",i),this.applyIncomingMessage(i)})},error:e=>{console.error("[Conversations] error getByToken",e),this.error="No se pudo obtener la sesi\xF3n",this.loading=!1,this.cdr.detectChanges()}})}ngOnDestroy(){this.eventsSub?.unsubscribe(),this.inboxSub?.unsubscribe()}loadConversations(t){if(!this.currentUserId){this.loading=!1,this.cdr.detectChanges();return}t&&!this.initialLoadDone&&(this.loading=!0,this.cdr.detectChanges()),console.log("[Conversations] cargando conversaciones de",this.currentUserId),this.convService.getByUser(this.currentUserId).subscribe({next:e=>{console.log("[Conversations] conversaciones recibidas",e),this.conversations=e.map(i=>I(y({},i),{lastTimeLabel:i.lastTime?this.formatTime(i.lastTime):""})),this.initialLoadDone=!0,this.loading=!1,this.cdr.detectChanges(),this.conversations.forEach(i=>{this.http.get(`/app/v1/presence/realtime/${i.id}`,{responseType:"text"}).subscribe({next:c=>{i.presenceStatus=c,this.cdr.detectChanges()},error:()=>{i.presenceStatus="OFFLINE"}})})},error:e=>{console.error("[Conversations] error getByUser",e),this.error="No se pudieron cargar conversaciones",this.loading=!1,this.cdr.detectChanges()}})}applyIncomingMessage(t){if(!this.currentUserId)return;let e=t.senderId===this.currentUserId?t.receiverId:t.senderId;if(!e)return;let i=this.conversations.findIndex(m=>m.id===e),c=t.timestamp,d=this.formatTime(c),S=this.selectedConversationId===e;if(i>=0){let m=this.conversations[i],P=I(y({},m),{lastMessage:t.content,lastTime:c,lastTimeLabel:d,unreadCount:S?m.unreadCount:m.unreadCount+1}),J=this.conversations.filter((ge,Q)=>Q!==i);this.conversations=[P,...J]}else{let m={id:e,name:"Nuevo contacto",lastMessage:t.content,lastTime:c,lastTimeLabel:d,avatarUrl:"",unreadCount:1};this.conversations=[m,...this.conversations]}this.cdr.detectChanges()}formatTime(t){let e=new Date(t),i=new Date;if(e.getFullYear()===i.getFullYear()&&e.getMonth()===i.getMonth()&&e.getDate()===i.getDate())return e.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});let d=new Date;return d.setDate(i.getDate()-1),e.getFullYear()===d.getFullYear()&&e.getMonth()===d.getMonth()&&e.getDate()===d.getDate()?"Ayer":e.toLocaleDateString("es-ES",{day:"2-digit",month:"2-digit"})}openConversation(t){this.selectedConversationId=t.id,this.router.navigate(["/dashboard/chat",t.id])}newConversation(){this.showNewConversation=!0,this.searchTerm="",this.searchResults=[]}closeNewConversation(){this.showNewConversation=!1}onSearchChange(){let t=(this.searchTerm||"").trim();if(!t||t.length<2){this.searchResults=[];return}this.userService.searchUsers(this.searchTerm,this.currentUserId??void 0).subscribe({next:e=>{this.searchResults=e,this.cdr.detectChanges()},error:e=>{console.error("[Conversations] error searchUsers:",e),this.searchResults=[],this.cdr.detectChanges()}})}startConversationWith(t){this.router.navigate(["/dashboard/chat",t.id]),this.showNewConversation=!1}static \u0275fac=function(e){return new(e||n)(v(L),v(w),v(A),v(W),v(K),v(q),v(b),v(z))};static \u0275cmp=k({type:n,selectors:[["app-conversations"]],decls:25,vars:5,consts:[[1,"conversations-wrapper"],[1,"conversations-header"],[1,"tabs"],[1,"tab","active"],[1,"tab"],[1,"new-conversation-btn",3,"click"],[1,"conversations-title"],["class","loading",4,"ngIf"],["class","error",4,"ngIf"],["class","conversations-list",4,"ngIf"],["class","empty-conversations",4,"ngIf"],[1,"conversations-footer"],["class","new-conversation-layer",4,"ngIf"],[1,"loading"],[1,"error"],[1,"conversations-list"],["class","conversation-card","type","button",3,"active","click",4,"ngFor","ngForOf"],["type","button",1,"conversation-card",3,"click"],[1,"conversation-avatar"],[3,"src","alt"],[1,"conversation-main"],[1,"conversation-header-line"],[1,"conversation-name"],[1,"conversation-status"],[4,"ngIf"],[1,"conversation-time"],[1,"conversation-footer-line"],[1,"conversation-message"],["class","conversation-unread-badge",4,"ngIf"],[1,"conversation-unread-badge"],[1,"empty-conversations"],[1,"new-conversation-layer"],[1,"new-conversation-backdrop",3,"click"],[1,"new-conversation-panel",3,"click"],[1,"new-conversation-header"],[1,"header-titles"],["type","button",1,"close-btn",3,"click"],[1,"new-conversation-search"],[1,"search-icon"],["type","text","placeholder","Buscar por nombre o @usuario",3,"ngModelChange","input","ngModel"],[1,"new-conversation-results"],["class","empty-hint",4,"ngIf"],["type","button","class","search-result-item",3,"click",4,"ngFor","ngForOf"],[1,"empty-hint"],["type","button",1,"search-result-item",3,"click"],[1,"avatar"],[1,"user-main"],[1,"user-name"],[1,"user-username"]],template:function(e,i){e&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"button",3),a(4,"Conversaciones"),r(),o(5,"button",4),a(6,"Canales"),r(),o(7,"button",4),a(8,"Settings"),r()(),o(9,"button",5),h("click",function(){return i.newConversation()}),a(10," + Nueva Conversaci\xF3n "),r()(),o(11,"h2",6),a(12,"Conversaciones"),r(),f(13,te,2,0,"div",7)(14,ne,2,1,"div",8)(15,le,2,1,"div",9)(16,de,5,0,"div",10),o(17,"div",11)(18,"span"),a(19,"Enlaces R\xE1pidos"),r(),o(20,"span"),a(21,"\xB7"),r(),o(22,"span"),a(23,"Soporte"),r()()(),f(24,ue,19,4,"div",12)),e&2&&(s(13),l("ngIf",i.loading),s(),l("ngIf",!i.loading&&i.error),s(),l("ngIf",!i.loading&&!i.error&&i.conversations.length>0),s(),l("ngIf",!i.loading&&!i.error&&i.conversations.length===0),s(8),l("ngIf",i.showNewConversation))},dependencies:[R,j,V,H,B,$,Y],styles:['[_nghost-%COMP%]{display:block;height:100%}.conversations-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;height:100%;background:#020617;color:#e5e7eb;font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif}.conversations-header[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:space-between;padding:8px 4px 4px}.tabs[_ngcontent-%COMP%]{display:flex;gap:12px}.tab[_ngcontent-%COMP%]{border:none;background:transparent;color:#9ca3af;font-size:13px;padding-bottom:4px;cursor:pointer;position:relative}.tab.active[_ngcontent-%COMP%]{color:#f9fafb}.tab.active[_ngcontent-%COMP%]:after{content:"";position:absolute;left:0;bottom:0;height:2px;width:100%;border-radius:999px;background:#6366f1}.new-conversation-btn[_ngcontent-%COMP%]{border:none;border-radius:999px;padding:6px 14px;font-size:13px;font-weight:600;background:#6366f1;color:#f9fafb;cursor:pointer;box-shadow:0 0 12px #6366f166;transition:background .15s ease,transform .1s ease,box-shadow .1s ease}.new-conversation-btn[_ngcontent-%COMP%]:hover{background:#4f46e5;transform:translateY(-1px);box-shadow:0 0 16px #818cf899}.conversations-title[_ngcontent-%COMP%]{font-size:16px;font-weight:600;margin:4px 0 8px}.conversations-list[_ngcontent-%COMP%]{flex:1;overflow-y:auto;padding-right:4px;padding-bottom:8px}.conversation-card[_ngcontent-%COMP%]{width:100%;border:none;outline:none;text-align:left;background:#020617;border-radius:999px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:pointer;box-shadow:0 0 0 1px #111827;transition:background .15s ease,box-shadow .15s ease,transform .1s ease}.conversation-card[_ngcontent-%COMP%]:hover{background:#0b1120;box-shadow:0 0 0 1px #4b5563;transform:translateY(-1px)}.conversation-avatar[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:999px;overflow:hidden;flex-shrink:0}.conversation-avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.conversation-main[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:2px}.conversation-header-line[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:baseline;gap:8px}.conversation-name[_ngcontent-%COMP%]{font-size:14px;font-weight:600;color:#f9fafb;text-shadow:0 0 4px rgba(255,255,255,.12)}.conversation-time[_ngcontent-%COMP%]{font-size:11px;color:#9ca3af}.conversation-card.active[_ngcontent-%COMP%]   .conversation-name[_ngcontent-%COMP%]{color:#fff;font-weight:700}.conversation-message[_ngcontent-%COMP%]{font-size:13px;color:#9ca3af;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.conversations-footer[_ngcontent-%COMP%]{padding-top:6px;font-size:11px;color:#6b7280;display:flex;gap:6px}.new-conversation-layer[_ngcontent-%COMP%]{position:fixed;inset:0;z-index:40;display:flex;align-items:center;justify-content:center}.new-conversation-backdrop[_ngcontent-%COMP%]{position:absolute;inset:0;background:#0f172abf;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.new-conversation-panel[_ngcontent-%COMP%]{position:relative;z-index:41;width:420px;max-width:calc(100% - 32px);background:#020617;border-radius:18px;border:1px solid rgba(148,163,184,.6);box-shadow:0 24px 80px #0f172ae6;padding:18px 20px 16px;display:flex;flex-direction:column;gap:12px}.new-conversation-header[_ngcontent-%COMP%]{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}.new-conversation-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:16px;font-weight:600}.new-conversation-header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:2px 0 0;font-size:12px;color:#9ca3af}.close-btn[_ngcontent-%COMP%]{border:none;border-radius:999px;background:#111827;color:#e5e7eb;width:28px;height:28px;font-size:14px;cursor:pointer}.close-btn[_ngcontent-%COMP%]:hover{background:#1f2937}.new-conversation-search[_ngcontent-%COMP%]{margin-top:8px;display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:#020617;border:1px solid #374151}.new-conversation-search[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{flex:1;border:none;outline:none;background:transparent;color:#e5e7eb;font-size:13px}.new-conversation-results[_ngcontent-%COMP%]{margin-top:8px;max-height:260px;overflow-y:auto;display:flex;flex-direction:column;gap:6px}.search-result-item[_ngcontent-%COMP%]{border:none;background:#020617;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:10px;cursor:pointer;text-align:left}.search-result-item[_ngcontent-%COMP%]:hover{background:#111827}.search-result-item[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:999px;overflow:hidden;background:#1f2937}.search-result-item[_ngcontent-%COMP%]   .avatar[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.user-main[_ngcontent-%COMP%]{display:flex;flex-direction:column}.user-name[_ngcontent-%COMP%]{font-size:13px;font-weight:500;color:#f9fafb}.user-username[_ngcontent-%COMP%]{font-size:11px;color:#9ca3af}.empty-conversations[_ngcontent-%COMP%]{margin-top:2rem;text-align:center;color:#9ca3af}.empty-conversations[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{color:#e5e7eb;font-size:16px;margin-bottom:.25rem}.conversation-footer-line[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;gap:6px}.conversation-message[_ngcontent-%COMP%]{font-size:.85rem;color:#9ca3af;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex:1}.conversation-unread-badge[_ngcontent-%COMP%]{background:#6366f1;color:#fff;padding:2px 8px;font-size:.75rem;font-weight:600;border-radius:999px;min-width:20px;text-align:center}']})};export{G as Conversations};
