<div class="settings-container">
  <!-- COLUMNA IZQUIERDA: FORMULARIOS -->
  <div class="settings-main">
    <h1 class="settings-title">Configuraci√≥n General</h1>

    <!-- PERFIL DEL USUARIO -->
    <section class="settings-section">
      <div class="section-header">
        <span class="section-icon">üë§</span>
        <h2>Perfil del Usuario</h2>
      </div>
      <p class="section-description">Actualiza tu informaci√≥n personal aqu√≠.</p>

      <div class="form-group">
        <label for="username">Nombre de Usuario</label>
        <input 
          type="text" 
          id="username" 
          [(ngModel)]="username" 
          (ngModelChange)="onUsernameInput($event)"
          class="form-input"
          placeholder="Tu nombre de usuario"
        />
        <div style="margin-top:6px">
          <span *ngIf="usernameChecking" style="color:#666">Comprobando disponibilidad...</span>
          <span *ngIf="usernameAvailable === true" style="color:green">Nombre disponible</span>
          <span *ngIf="usernameAvailable === false" style="color:red">Nombre ya est√° en uso</span>
          <span *ngIf="usernameRequired" style="color:red; display:block; margin-top:6px">El nombre de usuario es obligatorio</span>
        </div>
      </div>

      <div class="form-group">
        <label for="status">Estado</label>
        <select id="status" [(ngModel)]="selectedStatus" class="form-select">
          <option *ngFor="let status of statusOptions" [value]="status">
            {{ status }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>Foto de Perfil</label>
        <div class="photo-control">
          <img 
            [src]="profileImage || 'https://i.pravatar.cc/150?img=12'" 
            alt="Foto de perfil" 
            class="profile-photo"
          />
          <button type="button" class="btn-change-photo" (click)="changePhoto()">
            Cambiar Foto
          </button>
        </div>
        <div class="photo-hint" style="margin-top:8px">
          <span [ngStyle]="{ color: photoValidationState === 'error' ? 'red' : (photoValidationState === 'ok' ? 'green' : '#666') }">
            {{ photoValidationMessage ? photoValidationMessage : 'M√°x. 10MB. Formatos: JPG, PNG, GIF, WEBP.' }}
          </span>
        </div>
      </div>
    </section>

    <!-- NOTIFICACIONES - SECCI√ìN 1 -->
    <section class="settings-section">
      <div class="section-header">
        <span class="section-icon">üîî</span>
        <h2>Notificaciones</h2>
      </div>
      <p class="section-description">Configura c√≥mo y cu√°ndo recibir alertas.</p>

      <div class="toggle-group">
        <div class="toggle-item">
          <div>
            <label>Activar notificaciones</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" [(ngModel)]="notificationsSettings.activate" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="toggle-item">
          <div>
            <label>Sonidos de mensajes</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" [(ngModel)]="notificationsSettings.sound" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="toggle-item">
          <div>
            <label>Notificaciones en el escritorio</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" [(ngModel)]="notificationsSettings.desktop" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </section>

    <!-- APARIENCIA -->
    <section class="settings-section">
      <div class="section-header">
        <span class="section-icon">üé®</span>
        <h2>Apariencia</h2>
      </div>
      <p class="section-description">Personaliza el aspecto de la aplicaci√≥n.</p>

      <div class="toggle-group">
        <div class="toggle-item">
          <div>
            <label>Modo Oscuro</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" [(ngModel)]="appearanceSettings.darkMode" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>

      <div class="form-group">
        <label for="fontSize">Tama√±o de Fuente: {{ appearanceSettings.fontSize }}px</label>
        <input 
          type="range" 
          id="fontSize" 
          min="12" 
          max="20" 
          [(ngModel)]="appearanceSettings.fontSize"
          class="slider"
        />
      </div>
    </section>

    <!-- NOTIFICACIONES - SECCI√ìN 2 -->
    <section class="settings-section">
      <div class="section-header">
        <span class="section-icon">üì¨</span>
        <h2>Notificaciones</h2>
      </div>
      <p class="section-description">Controla c√≥mo recibes las notificaciones de la aplicaci√≥n.</p>

      <div class="toggle-group">
        <div class="toggle-item">
          <div>
            <label>Notificaciones por correo electr√≥nico</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" [(ngModel)]="notificationPreferences.email" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="toggle-item">
          <div>
            <label>Notificaciones push</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" [(ngModel)]="notificationPreferences.push" />
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div class="toggle-item">
          <div>
            <label>Notificaciones en la aplicaci√≥n</label>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" [(ngModel)]="notificationPreferences.inApp" />
            <span class="toggle-slider"></span>
          </label>
        </div>
      </div>
    </section>

    <!-- IDIOMA Y ZONA HORARIA -->
    <section class="settings-section">
      <div class="section-header">
        <span class="section-icon">üåç</span>
        <h2>Idioma y Zona Horaria</h2>
      </div>
      <p class="section-description">Ajusta tu idioma de interfaz y zona horaria.</p>

      <div class="form-group">
        <label for="language">Idioma de la interfaz</label>
        <select 
          id="language" 
          [(ngModel)]="languageSettings.interfaceLanguage" 
          class="form-select"
        >
          <option *ngFor="let lang of languageOptions" [value]="lang">
            {{ lang | titlecase }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="timezone">Zona horaria</label>
        <select 
          id="timezone" 
          [(ngModel)]="languageSettings.timezone" 
          class="form-select"
        >
          <option *ngFor="let tz of timezoneOptions" [value]="tz">
            {{ tz }}
          </option>
        </select>
      </div>
    </section>

    <!-- BOT√ìN RESTABLECER -->
    <!-- SEGURIDAD E INICIO DE SESI√ìN -->
    <section class="settings-section">
      <div class="section-header">
        <span class="section-icon">üîí</span>
        <h2>Seguridad e inicio de sesi√≥n</h2>
      </div>
      <p class="section-description">Revisa d√≥nde se ha iniciado sesi√≥n y gestiona sesiones activas. Se solicitar√° tu contrase√±a para acceder.</p>

      <!-- Use the tabs inside the secured area; openSecurity triggers modal -->
      <div class="form-group">
        <button type="button" class="btn-change-photo" (click)="openSecurity('where')">Abrir Seguridad</button>
      </div>

      <div *ngIf="showSecurity" class="security-content">
        <div class="security-tabs">
          <button [class.active]="selectedSecurityTab === 'where'" (click)="selectedSecurityTab='where'">D√≥nde se ha iniciado sesi√≥n</button>
          <button [class.active]="selectedSecurityTab === 'current'" (click)="selectedSecurityTab='current'">Sesiones actuales</button>
        </div>

        <div *ngIf="selectedSecurityTab === 'where'" class="security-table">
          <table>
            <thead>
              <tr>
                <th>Dispositivo</th>
                <th>Navegador</th>
                <th>Ubicaci√≥n</th>
                <th>IP</th>
                <th>√öltimo acceso</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="sessionsLoading"><td colspan="5">Cargando sesiones...</td></tr>
              <tr *ngFor="let s of sessionsAll">
                <td>{{ s.device }}</td>
                <td>{{ s.browser }}</td>
                <td>{{ s.location }}</td>
                <td>{{ s.ipAddress }}</td>
                <td>{{ s.lastActivity | date:'short' }}</td>
              </tr>
              <tr *ngIf="!sessionsLoading && sessionsAll.length === 0"><td colspan="5">No hay sesiones registradas.</td></tr>
            </tbody>
          </table>
        </div>

        <div *ngIf="selectedSecurityTab === 'current'" class="security-table">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div></div>
            <div>
              <button class="btn-change-photo" type="button" (click)="logoutAllSessions()">Cerrar todas</button>
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Dispositivo</th>
                <th>Navegador</th>
                <th>Ubicaci√≥n</th>
                <th>IP</th>
                <th>Acci√≥n</th>
                <th>Estado</th>
                <th>√öltimo acceso</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngIf="sessionsLoading"><td colspan="7">Cargando sesiones...</td></tr>
              <tr *ngFor="let s of sessionsCurrent">
                <td>{{ s.device }}</td>
                <td>{{ s.browser }}</td>
                <td>{{ s.location }}</td>
                <td>{{ s.ipAddress }}</td>
                <td>
                  <button class="btn-change-photo" type="button" (click)="logoutSession(s.sessionId)">Cerrar</button>
                </td>
                <td>{{ s.status }}</td>
                <td>{{ s.lastActivity | date:'short' }}</td>
              </tr>
              <tr *ngIf="!sessionsLoading && sessionsCurrent.length === 0"><td colspan="7">No hay sesiones activas.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <button type="button" class="btn-reset" (click)="resetDefaults()">
      Restablecer a valores predeterminados
    </button>
  </div>

  <!-- COLUMNA DERECHA: PREVIEW -->
  <aside class="settings-preview">
    <div class="preview-card">
      <h3 class="preview-title">Previsualizaci√≥n del Perfil</h3>
      <p class="preview-subtitle">As√≠ te ver√°n los dem√°s.</p>

      <div class="preview-profile">
        <div class="preview-avatar-wrapper">
          <img 
            [src]="profileImage || 'https://i.pravatar.cc/150?img=12'" 
            alt="Avatar" 
            class="preview-avatar"
          />
          <span class="preview-status-dot" [class.online]="selectedStatus === 'Online'"></span>
        </div>

        <h4 class="preview-username">{{ username }}</h4>
        <span class="preview-status">{{ selectedStatus }}</span>

        <p class="preview-note">
          Tu perfil se ver√° as√≠ para otros usuarios. Los cambios se aplicar√°n al guardar.
        </p>
      </div>

      <div *ngIf="photoValidationState === 'error' || usernameAvailable === false || usernameRequired === true" style="margin-top:8px; color:red; font-weight:600">
        Cambios no v√°lidos
      </div>

      <button *ngIf="!(photoValidationState === 'error' || usernameAvailable === false || usernameRequired === true)" type="button" class="btn-save" (click)="saveChanges()" [disabled]="uploadingPhoto" [attr.aria-busy]="uploadingPhoto">
        <span *ngIf="!uploadingPhoto" class="btn-icon">üíæ</span>
        <span *ngIf="uploadingPhoto" class="btn-icon">‚è≥</span>
        <span *ngIf="!uploadingPhoto"> Guardar Cambios</span>
        <span *ngIf="uploadingPhoto"> Guardando...</span>
      </button>
      <div *ngIf="uploadMessage" style="margin-top:10px">
        <span [ngStyle]="{ color: uploadMessageType === 'error' ? 'red' : (uploadMessageType === 'success' ? 'green' : '#333') }">{{ uploadMessage }}</span>
      </div>
    </div>
  </aside>
</div>

<!-- Modal confirmar contrase√±a -->
<div class="modal-backdrop" *ngIf="showPasswordModal">
  <form class="modal-card" (ngSubmit)="confirmPassword($event)" autocomplete="off">
    <h3>Confirma tu contrase√±a</h3>
    <p>Introduce tu contrase√±a para acceder a Seguridad e inicio de sesi√≥n.</p>
    <input
      type="password"
      [(ngModel)]="passwordConfirm"
      name="passwordConfirm"
      class="form-input"
      placeholder="Contrase√±a"
      autocomplete="new-password"
    />
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end">
      <button class="btn-change-photo" type="button" (click)="showPasswordModal=false">Cancelar</button>
      <button class="btn-save" type="submit" [disabled]="isVerifyingPassword">Confirmar</button>
    </div>
  </form>
</div>
