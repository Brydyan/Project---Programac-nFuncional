<form [formGroup]="registerForm" (ngSubmit)="onRegisterSubmit()" novalidate>

  <div class="logo-container">
    <h1><span class="logo-icon">üí¨</span> YARG Flow</h1>
    <h2 class="form-title">Crear una cuenta</h2>
  </div>

  <!-- EMAIL -->
  <div class="form-group">
    <label for="email">Correo electr√≥nico</label>
    <input id="email" formControlName="email" type="email"
      placeholder="correo@ejemplo.com"
      autocomplete="email"
      (keydown)="onKeyNavigate($event, 'email')"
      (blur)="onEmailBlur()" />

    <div class="state-message">
      @switch (true) {
        @case (email?.invalid && email?.touched) {
          <div class="error-message">Correo electr√≥nico inv√°lido.</div>
        }
        @case (email?.valid && email?.touched && emailAvailability.checking) {
          <div class="info-message">Verificando disponibilidad...</div>
        }
        @case (email?.valid && email?.touched && emailAvailability.available === false) {
          <div class="error-message">Este correo ya est√° registrado.</div>
        }
        @case (email?.valid && email?.touched && emailAvailability.available === true) {
          <div class="success-message">‚úì Correo disponible</div>
        }
      }
    </div>
  </div>

  <!-- NOMBRE -->
  <div class="form-group">
    <label for="nombre">Nombre</label>
    <input id="nombre" formControlName="nombre" type="text"
      placeholder="Tu nombre completo"
      (keydown)="onKeyNavigate($event, 'nombre')" />
  </div>

  <!-- ALIAS -->
  <div class="form-group">
    <label for="alias">Alias</label>
    <input id="alias" formControlName="alias" type="text"
      placeholder="Tu alias o apodo" autocomplete="username"
      (keydown)="onKeyNavigate($event, 'alias')"
      (blur)="onAliasBlur()" />

    <div class="state-message">
      @switch (true) {
        @case (alias?.invalid && alias?.touched) {
          <div class="error-message">Alias inv√°lido o muy corto.</div>
        }
        @case (alias?.valid && alias?.touched && usernameAvailability.checking) {
          <div class="info-message">Verificando disponibilidad...</div>
        }
        @case (alias?.valid && alias?.touched && usernameAvailability.available === false) {
          <div class="error-message">Este alias ya est√° registrado.</div>
        }
        @case (alias?.valid && alias?.touched && usernameAvailability.available === true) {
          <div class="success-message">‚úì Alias disponible</div>
        }
      }
    </div>
  </div>

  <!-- PASSWORD -->
  <div class="form-group">
    <label for="password">Contrase√±a</label>
    <input id="password" [type]="showPassword ? 'text':'password'"
      formControlName="password" placeholder="Contrase√±a"
      autocomplete="new-password"
      (keydown)="onKeyNavigate($event, 'password')" />

    @if (password?.touched && password?.invalid) {
      <div class="error-message" *ngIf="password?.errors?.['required']">La contrase√±a es requerida.</div>
      <div class="error-message" *ngIf="password?.errors?.['minlength']">M√≠nimo 8 caracteres.</div>
      <div class="error-message" *ngIf="password?.errors?.['pattern']">
        Debe contener may√∫scula, n√∫mero y car√°cter especial.
      </div>
    }
  </div>

  <!-- CONFIRM PASSWORD -->
  <div class="form-group">
    <label for="confirmPassword">Confirmar Contrase√±a</label>

    <input id="confirmPassword" [type]="showPassword ? 'text':'password'"
      formControlName="confirmPassword" placeholder="Confirmar contrase√±a"
      autocomplete="new-password"
      (keydown)="onKeyNavigate($event, 'confirmPassword')" />

    @if (registerForm.hasError('mismatch') && confirmPassword?.touched) {
      <div class="error-message">Las contrase√±as no coinciden.</div>
    }
  </div>

  <label class="checkbox-label">
    <input type="checkbox" (change)="toggleShowPassword()" /> Mostrar Contrase√±a
  </label>

  <!-- FECHA -->
  <div class="form-group">
    <label>Fecha de nacimiento</label>

    <div class="date-group">
      <input id="day" formControlName="day" type="text" maxlength="2"
        placeholder="dd" inputmode="numeric"
        (input)="onDigitsInput($event, 'month', 2)"
        (keydown)="onKeyNavigate($event, 'day')" />

      <input id="month" formControlName="month" type="text" maxlength="2"
        placeholder="mm" inputmode="numeric"
        (input)="onDigitsInput($event, 'year', 2)"
        (keydown)="onKeyNavigate($event, 'month')" />

      <input id="year" formControlName="year" type="text" maxlength="4"
        placeholder="aaaa" inputmode="numeric"
        (input)="onDigitsInput($event, 'submitBtn', 4)"
        (keydown)="onKeyNavigate($event, 'year')" />
    </div>

    @if (registerForm.touched) {
      <div class="error-message" *ngIf="registerForm.hasError('invalidDate')">Ingresa una fecha v√°lida.</div>
      <div class="error-message" *ngIf="registerForm.hasError('invalidDay')">D√≠a inv√°lido.</div>
      <div class="error-message" *ngIf="registerForm.hasError('invalidMonth')">Mes inv√°lido.</div>
      <div class="error-message" *ngIf="registerForm.hasError('invalidYear')">A√±o inv√°lido.</div>
      <div class="error-message" *ngIf="registerForm.hasError('nonexistentDate')">La fecha no existe.</div>
      <div class="error-message" *ngIf="registerForm.hasError('tooYoung')">Debes tener al menos 13 a√±os.</div>
      <div class="error-message" *ngIf="registerForm.hasError('tooOld')">Fecha demasiado antigua.</div>
    }
  </div>

  <button id="submitBtn" type="submit"
    [disabled]="registerForm.invalid || isLoading ||
                usernameAvailability.available === false ||
                emailAvailability.available === false">
    Registrar cuenta
  </button>

  <div *ngIf="isLoading" class="info-message">Registrando...</div>
  <div *ngIf="message" class="info-message">{{ message }}</div>

</form>
